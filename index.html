<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Cave Pro - Fix Android</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white p-6">

    <h1 class="text-xl font-bold amber-500 text-center mb-8 uppercase tracking-widest">ðŸ¥ƒ My Cellar</h1>

    <div class="bg-zinc-900 p-10 rounded-[2rem] text-center mb-10 border border-zinc-800 shadow-2xl">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
        <button onclick="document.getElementById('cameraInput').click()" class="bg-amber-600 text-black w-full py-5 rounded-2xl font-black text-lg shadow-lg">
            ðŸ“¸ SCANNER LA BOUTEILLE
        </button>
    </div>

    <div id="bottleList" class="space-y-4"></div>

    <div class="mt-10 p-6 bg-zinc-900 rounded-2xl border border-zinc-800">
        <p class="text-[10px] font-bold uppercase mb-4 text-zinc-500">ðŸ”‘ ClÃ© API Gemini</p>
        <input type="text" id="keyInput" placeholder="AIza..." class="w-full bg-black border border-zinc-700 p-4 rounded-xl text-xs text-white mb-4 outline-none">
        <button onclick="saveKey()" class="w-full bg-amber-600/10 text-amber-500 py-3 rounded-xl text-[10px] font-bold uppercase border border-amber-600/20">
            Fixer la clÃ© sur ce tÃ©lÃ©phone
        </button>
    </div>

    <div id="loader" class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-50">
        <div class="w-12 h-12 border-4 border-amber-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-amber-600 font-bold text-xs animate-pulse">ANALYSE EN COURS...</p>
    </div>

    <script>
        // On change le nom du stockage pour forcer un nettoyage
        let inventory = JSON.parse(localStorage.getItem('myCellar_ANDROID_FIX')) || [];
        
        window.onload = () => {
            const savedKey = localStorage.getItem('maCleIA_ANDROID');
            if (savedKey) document.getElementById('keyInput').value = savedKey;
            render();
        };

        function saveKey() {
            // NETTOYAGE RADICAL : On ne garde que lettres, chiffres, tirets et underscores
            let val = document.getElementById('keyInput').value.trim();
            val = val.replace(/[^a-zA-Z0-9\-_]/g, ""); 
            
            if (val.startsWith("AIza")) {
                localStorage.setItem('maCleIA_ANDROID', val);
                document.getElementById('keyInput').value = val;
                alert("ClÃ© nettoyÃ©e et enregistrÃ©e !");
            } else {
                alert("La clÃ© doit commencer par AIza");
            }
        }

        document.getElementById('cameraInput').onchange = async (e) => {
            const file = e.target.files[0];
            let API_KEY = localStorage.getItem('maCleIA_ANDROID');

            if (!API_KEY) return alert("Veuillez enregistrer votre clÃ© en bas de page.");

            document.getElementById('loader').classList.remove('hidden');
            const reader = new FileReader();
            
            reader.onload = async () => {
                const base64Image = reader.result.split(',')[1];
                try {
                    // On force l'URL v1beta qui est la plus flexible en Europe
                    const URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                    
                    const response = await fetch(URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [
                                { text: "RÃ©ponds UNIQUEMENT en JSON : {\"nom\":\"...\",\"type\":\"...\",\"prix\":\"...\",\"histoire\":\"...\",\"note\":80}" },
                                { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                            ]}]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        // Si Ã§a Ã©choue encore, on affiche la clÃ© utilisÃ©e (tronquÃ©e) pour vÃ©rifier
                        const debut = API_KEY.substring(0,6);
                        alert("Erreur Google : " + data.error.message + "\nClÃ© utilisÃ©e commence par : " + debut);
                        throw new Error(data.error.message);
                    }

                    let rawText = data.candidates[0].content.parts[0].text;
                    const start = rawText.indexOf('{');
                    const end = rawText.lastIndexOf('}');
                    const jsonString = rawText.substring(start, end + 1);
                    const b = JSON.parse(jsonString);
                    
                    inventory.unshift({ ...b, id: Date.now() });
                    localStorage.setItem('myCellar_ANDROID_FIX', JSON.stringify(inventory));
                    render();
                } catch (err) {
                    console.error(err);
                } finally {
                    document.getElementById('loader').classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        };

        function render() {
            const container = document.getElementById('bottleList');
            container.innerHTML = inventory.map(item => `
                <div class="bg-zinc-900 p-6 rounded-3xl border-l-4 border-amber-600 mb-4">
                    <h3 class="font-bold text-white text-lg">${item.nom}</h3>
                    <p class="text-amber-600 text-[10px] font-black uppercase mt-1 tracking-widest">${item.type} â€¢ ${item.note}/100</p>
                    <p class="text-zinc-400 text-xs mt-4 italic leading-relaxed">"${item.histoire}"</p>
                    <p class="text-white text-xs font-bold mt-4 pt-3 border-t border-zinc-800 flex justify-between uppercase">
                        <span class="text-zinc-500">Prix</span> ${item.prix}
                    </p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
