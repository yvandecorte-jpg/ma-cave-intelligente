<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Cave Pro - Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-white p-5">

    <h1 class="text-xl font-black text-center mb-8 amber tracking-tighter uppercase">ðŸ¥ƒ My Cellar Debug</h1>

    <div class="bg-zinc-900 p-6 rounded-3xl mb-8 border border-zinc-800">
        <p class="text-[10px] font-bold text-amber-500 uppercase mb-3">1. Configuration de la clÃ©</p>
        <input type="text" id="keyInput" placeholder="Coller la clÃ© AIza..." 
               class="w-full bg-black border border-zinc-700 p-4 rounded-xl text-xs mb-4 focus:border-amber-500 outline-none">
        <button onclick="validerCle()" class="w-full bg-white text-black font-bold py-3 rounded-xl text-xs uppercase">
            Enregistrer et VÃ©rifier
        </button>
        <p id="keyStatus" class="text-[9px] mt-2 text-center text-zinc-500 italic">Aucune clÃ© enregistrÃ©e</p>
    </div>

    <div id="scanZone" class="opacity-30 pointer-events-none transition-opacity duration-500 bg-zinc-900 p-8 rounded-3xl text-center border-2 border-dashed border-zinc-700">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
        <button onclick="document.getElementById('cameraInput').click()" class="bg-amber-500 text-black w-full py-5 rounded-2xl font-black">
            ðŸ“¸ SCANNER LA BOUTEILLE
        </button>
        <p class="text-[9px] mt-4 text-zinc-500 uppercase">L'IA Gemini 2.5 Flash s'activera ici</p>
    </div>

    <div id="bottleList" class="mt-8 space-y-4 pb-20"></div>

    <div id="loader" class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-50">
        <div class="w-10 h-10 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-amber-500 font-bold text-xs uppercase animate-pulse">Analyse en cours...</p>
    </div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('myCellarDB_v5')) || [];
        
        // Au dÃ©marrage, on vÃ©rifie si une clÃ© existe
        window.onload = () => {
            const stored = localStorage.getItem('maCleIA_v5');
            if (stored) {
                document.getElementById('keyInput').value = stored;
                activerScan();
            }
            render();
        };

        function validerCle() {
            let input = document.getElementById('keyInput').value.trim();
            // Nettoyage radical : on enlÃ¨ve les espaces, les sauts de ligne et les guillemets
            input = input.replace(/[\s"']/g, "");
            
            if (input.startsWith("AIza")) {
                localStorage.setItem('maCleIA_v5', input);
                document.getElementById('keyStatus').innerText = "âœ… ClÃ© formatÃ©e et enregistrÃ©e !";
                document.getElementById('keyStatus').classList.replace('text-zinc-500', 'text-green-500');
                activerScan();
                alert("La clÃ© est prÃªte. Vous pouvez maintenant scanner !");
            } else {
                alert("La clÃ© doit commencer par 'AIza'. VÃ©rifiez votre copier-coller.");
            }
        }

        function activerScan() {
            document.getElementById('scanZone').classList.remove('opacity-30', 'pointer-events-none');
        }

        document.getElementById('cameraInput').onchange = async (e) => {
            const file = e.target.files[0];
            const API_KEY = localStorage.getItem('maCleIA_v5');

            document.getElementById('loader').classList.remove('hidden');
            const reader = new FileReader();
            
            reader.onload = async () => {
                const base64Image = reader.result.split(',')[1];
                try {
                    // Utilisation forcÃ©e du modÃ¨le 2.5 Flash (2026)
                    const URL = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
                    
                    const response = await fetch(URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [
                                { text: "JSON ONLY: {\"nom\":\"...\",\"type\":\"Whisky ou Rhum\",\"prix\":\"...\",\"histoire\":\"...\",\"note\":80}" },
                                { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                            ]}]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        if (data.error.message.includes("API key")) {
                            throw new Error("La clÃ© est refusÃ©e par Google. VÃ©rifiez qu'elle n'est pas expirÃ©e ou supprimÃ©e dans AI Studio.");
                        }
                        throw new Error(data.error.message);
                    }

                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json|```/g, "").trim();
                    const b = JSON.parse(text);
                    
                    inventory.unshift({ ...b, id: Date.now() });
                    localStorage.setItem('myCellarDB_v5', JSON.stringify(inventory));
                    render();
                } catch (err) {
                    alert("ERREUR : " + err.message);
                } finally {
                    document.getElementById('loader').classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        };

        function render() {
            const container = document.getElementById('bottleList');
            container.innerHTML = inventory.map(item => `
                <div class="bg-zinc-900 p-5 rounded-2xl border-l-4 border-amber-500">
                    <h3 class="font-bold text-white text-sm">${item.nom}</h3>
                    <p class="text-zinc-500 text-[10px] uppercase font-bold">${item.type} â€¢ ${item.note}/100</p>
                    <p class="text-zinc-400 text-[11px] mt-2 italic">"${item.histoire}"</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
